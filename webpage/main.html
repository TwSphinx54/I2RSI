<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <title>解译结果</title>
    <link href="styles/style.css" rel="stylesheet" type="text/css">
</head>
<body>
<div id="background">
    <div id="f_title_bg"></div>
    <div id="f_main_title">
        目标提取
    </div>
    <div id="f_main_subtitle">
        Object Detection
    </div>
    <div class="index">
        <div class="card">预测耗时</div>
        <div class="card">平均得分</div>
        <div class="card">模型mAP</div>
        <div class="card">模型loss</div>
    </div>
    <div class="index">
        <div class="content">00</div>
        <div class="content">00</div>
        <div class="content">00</div>
        <div class="content">00</div>
    </div>
    <div id='res_prev'>
        <div id="back">
            <svg width="80" height="80" viewBox="-4 -4 50 50" stroke-width="2" stroke="currentColor" fill="none"
                 stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path d="M6 10h4v-4"></path>
                <path d="M4 4l6 6"></path>
                <path d="M18 14h-4v4"></path>
                <path d="M14 14l6 6"></path>
            </svg>
        </div>
        <img src="./res/result.png" id='prev_img' alt="process result" draggable="false">
        <div id="full_interact">
            <img src="./res/origin.png" id='ori_img' alt="process result" draggable="false">
        </div>
        <div id="detail">
            <img src="./res/origin.png" id='detail_img' alt="process result" draggable="false">
        </div>
    </div>
    <div id='ring'></div>
    <div id='fullscreen'>
        <svg width="80" height="80" viewBox="-3 -3 50 50" stroke-width="2" stroke="currentColor" fill="none"
             stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <polyline points="15 6 9 12 15 18"></polyline>
        </svg>
    </div>
</div>

<script>
    const type = {{ pro }};
    const elements = {{ ele }};
    // const type = {{pro}};

    const content = document.getElementsByClassName('content');
    let loc, score, period, shape;
    if (type === 0) {
        [score, period, shape] = elements;
        const oacc = 0.973445;
        const miou = 0.7738609047700991;
        content[2].innerHTML = '模型OAcc';
        content[3].innerHTML = '模型mIoU';

        NumAutoPlusAnimation('content', {
            time: 3500,
            num: period.toFixed(2),
            regulator: 50
        }, 0)
        NumAutoPlusAnimation('content', {
            time: 3500,
            num: score.toFixed(3),
            regulator: 50
        }, 1)
        NumAutoPlusAnimation('content', {
            time: 3500,
            num: oacc.toFixed(2),
            regulator: 50
        }, 2)
        NumAutoPlusAnimation('content', {
            time: 3500,
            num: miou.toFixed(2),
            regulator: 50
        }, 3)
    } else if (type === 1) {
        [score, period, shape] = elements;
        const miou = 0.114514;
        const f1 = 0.1919810;
        content[2].innerHTML = '模型mIoU';
        content[3].innerHTML = '模型F1';

        NumAutoPlusAnimation('content', {
            time: 3500,
            num: period.toFixed(2),
            regulator: 50
        }, 0)
        NumAutoPlusAnimation('content', {
            time: 3500,
            num: score.toFixed(3),
            regulator: 50
        }, 1)
        NumAutoPlusAnimation('content', {
            time: 3500,
            num: miou.toFixed(2),
            regulator: 50
        }, 2)
        NumAutoPlusAnimation('content', {
            time: 3500,
            num: f1.toFixed(2),
            regulator: 50
        }, 3)
    } else if (type === 2) {
        [loc, score, period, shape] = elements;
        const map = 68.30;
        const loss = 6.3706465;
        content[2].innerHTML = '模型mAP';
        content[3].innerHTML = '模型loss';

        NumAutoPlusAnimation('content', {
            time: 3500,
            num: period.toFixed(2),
            regulator: 50
        }, 0)
        if (score.length > 0) {
            NumAutoPlusAnimation('content', {
                time: 3500,
                num: (score.reduce((a, b) => a + b) / score.length).toFixed(3),
                regulator: 50
            }, 1)
        } else {
            document.getElementsByClassName('content')[1].innerHTML = 'Null';
        }
        NumAutoPlusAnimation('content', {
            time: 3500,
            num: map.toFixed(2),
            regulator: 50
        }, 2)
        NumAutoPlusAnimation('content', {
            time: 3500,
            num: loss.toFixed(2),
            regulator: 50
        }, 3)
    } else if (type === 3) {
        [score, period, shape] = elements;
        const n_score = [];
        for (let k = 0; k < score.length; k++) {
            if (score[k] > 0.01) {
                n_score.push(score[k]);
            }
        }
        const oacc = 0.85;
        const f1 = 0.47;
        content[2].innerHTML = '模型OAcc';
        content[3].innerHTML = '模型F1';

        NumAutoPlusAnimation('content', {
            time: 3500,
            num: period.toFixed(2),
            regulator: 50
        }, 0)
        if (n_score.length > 0) {
            NumAutoPlusAnimation('content', {
                time: 3500,
                num: (n_score.reduce((a, b) => a + b) / n_score.length).toFixed(3),
                regulator: 50
            }, 1)
        } else {
            document.getElementsByClassName('content')[1].innerHTML = 'Null';
        }
        NumAutoPlusAnimation('content', {
            time: 3500,
            num: oacc.toFixed(2),
            regulator: 50
        }, 2)
        NumAutoPlusAnimation('content', {
            time: 3500,
            num: f1.toFixed(2),
            regulator: 50
        }, 3)
    }

    function NumAutoPlusAnimation(targetEle, options, i) {
        options = options || {};

        let $this = document.getElementsByClassName(targetEle)[i],
            time = options.time || $this.data('time'), //总时间--毫秒为单位
            finalNum = options.num || $this.data('value'), //要显示的真实数值
            regulator = options.regulator || 100, //调速器，改变regulator的数值可以调节数字改变的速度

            step = finalNum / (time / regulator),/*每30ms增加的数值--*/
            count = 0, //计数器
            initial = 0;

        let timer = setInterval(function () {

            count = count + step;

            if (count >= finalNum) {
                clearInterval(timer);
                count = finalNum;
            }
            //t未发生改变的话就直接返回
            //避免调用text函数，提高DOM性能
            let t = count.toFixed(2);
            if (t === initial) return;

            initial = t;

            $this.innerHTML = initial;
        }, 30);
    }

    const f_main_title = document.getElementById('f_main_title');
    const f_main_subtitle = document.getElementById('f_main_subtitle');
    const f_title_bg = document.getElementById('f_title_bg');
    const card = document.getElementsByClassName('card');
    const res_prev = document.getElementById('res_prev');
    const ring = document.getElementById('ring');
    const fullscreen = document.getElementById('fullscreen');
    const back = document.getElementById('back');
    const prev_img = document.getElementById('prev_img');
    const full_interact = document.getElementById('full_interact');
    const ori_img = document.getElementById('ori_img');
    const detail = document.getElementById('detail');
    const detail_img = document.getElementById('detail_img');

    const type_name = ['目标提取', '变化检测', '目标检测', '地物分类'];
    const type_eng = ['Object extraction', 'Change detection', 'Object detection', 'Feature classification'];
    let mode = 'prev';

    function show(type) {
        f_main_title.innerHTML = type_name[type];
        f_main_subtitle.innerHTML = type_eng[type];
        f_main_title.classList.add('show');
        f_main_subtitle.classList.add('show');
        f_title_bg.classList.add('show');
        res_prev.classList.add('show');

        for (let i = 0; i < card.length; i++) {
            card[i].classList.add('show');
            content[i].classList.add('show');
        }
    }

    show(type);

    for (let i = 0; i < content.length; i++) {
        content[i].onmouseover = function () {
            content[i].classList.add('blur');
            content[i].classList.add('focus');
            card[i].classList.add('focus');
        }
        content[i].onmouseout = function () {
            content[i].classList.remove('focus');
            card[i].classList.remove('focus');
        }
    }

    res_prev.onmouseover = function () {
        if (mode === 'prev') {
            ring.classList.add('show');
            fullscreen.classList.add('show');
        }
    }
    res_prev.onmouseout = function () {
        if (mode === 'prev') {
            ring.classList.remove('show');
            fullscreen.classList.remove('show');
            if (fullscreen.classList.contains('clicked')) {
                fullscreen.classList.remove('clicked');
            }
        }
    }

    fullscreen.onmouseover = function () {
        if (mode === 'prev') {
            ring.classList.add('show');
            fullscreen.classList.add('show');
        }
    }
    fullscreen.onclick = function () {
        mode = 'detail';
        fullscreen.classList.add('clicked');
        ring.classList.remove('show');
        fullscreen.classList.remove('show');
        res_prev.classList.add('full')
        prev_img.classList.add('fade');
        full_interact.classList.add('show')
        back.classList.add('show');
        detail.classList.add('show');
        ori_img.classList.add('show');
    }
    if (type === 0) {
        const obj = document.createElement('img');
        obj.className = 'types_img';
        full_interact.appendChild(obj);
        obj.src = './res/roads.png';
        obj.draggable = false;

        let r = window.innerHeight * 0.95 / shape[0]
        full_interact.style.width = (r * shape[1]).toString() + 'px'
        let d_width = window.innerWidth * 0.95 - r * shape[1] - 70;
        detail.style.width = (d_width).toString() + 'px'
        let d_height = window.innerHeight * 0.95;

        detail_img.src = './res/roads.png';

        function fit_img(w, h) {
            let rrw = d_width / w;
            let rrh = d_height / h;
            if (rrh >= rrw) {
                detail_img.style.width = d_width.toString() + 'px';
                detail_img.style.height = (h * rrw).toString() + 'px';
                detail_img.style.left = '0';
                detail_img.style.top = '50%';
                detail_img.style.marginLeft = '0';
                detail_img.style.marginTop = '-' + (h * rrw / 2) + 'px';
            } else {
                detail_img.style.height = d_height.toString() + 'px';
                detail_img.style.width = (w * rrh).toString() + 'px';
                detail_img.style.top = '0';
                detail_img.style.left = '50%';
                detail_img.style.marginTop = '0';
                detail_img.style.marginLeft = '-' + (w * rrh / 2) + 'px';
            }
        }

        fit_img(shape[1], shape[0]);

    } else if (type === 1) {
        ori_img.src = './res/A.png';
        ori_img.style.opacity = '50%';

        const B_img = document.createElement('img');
        B_img.className = 'types_img';
        full_interact.appendChild(B_img);
        B_img.src = './res/B.png';

        const change = document.createElement('img');
        change.className = 'types_img';
        full_interact.appendChild(change);
        change.src = './res/change.png';
        change.draggable = false;

        let r = window.innerHeight * 0.95 / shape[0]
        full_interact.style.width = (r * shape[1]).toString() + 'px'
        let d_width = window.innerWidth * 0.95 - r * shape[1] - 70;
        detail.style.width = (d_width).toString() + 'px'
        let d_height = window.innerHeight * 0.95;
        detail_img.style.display = 'none';

        const detail_A = document.createElement('div');
        detail_A.className = 'AB_detail';
        detail.appendChild(detail_A);
        detail_A.style.top = '1%';

        const detail_B = document.createElement('div');
        detail_B.className = 'AB_detail';
        detail.appendChild(detail_B);
        detail_B.style.bottom = '1%';

        const detail_A_img = document.createElement('img');
        detail_A_img.className = 'AB_detail_img';
        detail_A.appendChild(detail_A_img);
        detail_A_img.src = './res/A.png';

        const detail_B_img = document.createElement('img');
        detail_B_img.className = 'AB_detail_img';
        detail_B.appendChild(detail_B_img);
        detail_B_img.src = './res/B.png';

        function fit_AB_img(img, w, h) {
            let ow = d_width;
            let oh = d_height * 0.485;
            let rrw = ow / w;
            let rrh = oh / h;
            if (rrh >= rrw) {
                img.style.width = ow.toString() + 'px';
                img.style.height = (h * rrw).toString() + 'px';
            } else {
                img.style.height = oh.toString() + 'px';
                img.style.width = (w * rrh).toString() + 'px';
            }
        }

        fit_AB_img(detail_A_img, shape[0], shape[1]);
        fit_AB_img(detail_B_img, shape[0], shape[1]);

        let x_s, y_s;
        let cf = false;
        full_interact.onmousedown = function (e) {
            const select_box = document.createElement('div');
            select_box.id = 'select_box';
            full_interact.appendChild(select_box);

            x_s = e.clientX;
            y_s = e.clientY;
            select_box.style.left = x_s.toString() + 'px';
            select_box.style.top = y_s.toString() + 'px';
            cf = true;
        }
        full_interact.onmousemove = function (e) {
            if (cf) {
                const select_box = document.getElementById('select_box');
                let x_t = e.clientX;
                let y_t = e.clientY;
                select_box.style.width = Math.abs(x_t - x_s).toString() + 'px';
                select_box.style.height = Math.abs(y_t - y_s).toString() + 'px';

                if ((x_t >= x_s) && (y_t < y_s)) {
                    select_box.style.top = y_t.toString() + 'px';
                } else if (x_t < x_s) {
                    select_box.style.left = x_t.toString() + 'px';
                    if (y_t < y_s) {
                        select_box.style.top = y_t.toString() + 'px';
                    }
                }
            }
        }
        full_interact.onmouseup = function (e) {
            if (cf) {
                document.getElementById('select_box').remove();
                let x_e = e.clientX - (window.innerWidth * 0.975 - r * shape[1]);
                let y_e = e.clientY - (window.innerHeight * 0.025);
                let x_ss = x_s - (window.innerWidth * 0.975 - r * shape[1]);
                let y_ss = y_s - (window.innerHeight * 0.025);

                if ((Math.abs(x_e - x_ss) > 10) && (Math.abs(y_e - y_ss) > 10)) {
                    let url = 'http://127.0.0.1:8080/result'
                    let xhr = new XMLHttpRequest();
                    xhr.open('POST', url, true);
                    let formData = new FormData();
                    formData.append('status', 'select')
                    formData.append('x0', x_ss / r)
                    formData.append('y0', y_ss / r)
                    formData.append('x1', x_e / r)
                    formData.append('y1', y_e / r)
                    xhr.send(formData)
                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                            let size = JSON.parse(xhr.response)
                            detail_A_img.src = './res/clipA.png?' + Math.random();
                            detail_B_img.src = './res/clipB.png?' + Math.random();
                            fit_AB_img(detail_A_img, size.w, size.h);
                            fit_AB_img(detail_B_img, size.w, size.h);
                        }
                    }
                } else {
                    if (document.getElementById('select_box')) {
                        document.getElementById('select_box').remove();
                    }
                    detail_A_img.src = './res/A.png';
                    detail_B_img.src = './res/B.png';
                    fit_AB_img(detail_A_img, shape[0], shape[1]);
                    fit_AB_img(detail_B_img, shape[0], shape[1]);
                }
            }
            cf = false;
        }
        full_interact.onclick = function () {
            if (cf) {
                if (document.getElementById('select_box')) {
                    document.getElementById('select_box').remove();
                }
                cf = false;
                detail_A_img.src = './res/A.png';
                detail_B_img.src = './res/B.png';
                fit_AB_img(detail_A_img, shape[0], shape[1]);
                fit_AB_img(detail_B_img, shape[0], shape[1]);
            }
        }
    } else if (type === 2) {
        function fit_img(w, h) {
            let rrw = d_width / w;
            let rrh = d_height / h;
            if (rrh >= rrw) {
                detail_img.style.width = d_width.toString() + 'px';
                detail_img.style.height = (h * rrw).toString() + 'px';
                detail_img.style.left = '0';
                detail_img.style.top = '50%';
                detail_img.style.marginLeft = '0';
                detail_img.style.marginTop = '-' + (h * rrw / 2) + 'px';
            } else {
                detail_img.style.height = d_height.toString() + 'px';
                detail_img.style.width = (w * rrh).toString() + 'px';
                detail_img.style.top = '0';
                detail_img.style.left = '50%';
                detail_img.style.marginTop = '0';
                detail_img.style.marginLeft = '-' + (w * rrh / 2) + 'px';
            }
        }

        let r = window.innerHeight * 0.95 / shape[0];
        full_interact.style.width = (r * shape[1]).toString() + 'px';
        let d_width = window.innerWidth * 0.95 - r * shape[1] - 70;
        detail.style.width = (d_width).toString() + 'px';
        let d_height = window.innerHeight * 0.95;
        fit_img(shape[1], shape[0]);

        let flag = new Uint8Array(loc.length);
        let bbox_c = [];
        for (let k = 0; k < loc.length; k++) {
            let this_loc = loc[k];
            const bbox = document.createElement('div');
            bbox.className = 'bbox';
            full_interact.appendChild(bbox);
            let t_width = (this_loc[2] - this_loc[0]) * r;
            let t_height = (this_loc[3] - this_loc[1]) * r;
            let t_top = this_loc[1] * r;
            let t_left = this_loc[0] * r;
            bbox.style.width = t_width.toString() + 'px';
            bbox.style.height = t_height.toString() + 'px';
            bbox.style.top = t_top.toString() + 'px';
            bbox.style.left = t_left.toString() + 'px';
            bbox_c.push([t_width / r, t_height / r, t_top / r, t_left / r]);
            bbox.style.lineHeight = t_height.toString() + 'px';
            bbox.style.fontSize = (t_width / 3).toString() + 'px';
        }

        bbox = document.getElementsByClassName('bbox');
        for (let i = 0; i < bbox.length; i++) {
            bbox[i].onclick = function () {
                if (flag[i] === 0) {
                    let prev = flag.indexOf(1)
                    if (prev > -1) {
                        flag[prev] = 0;
                        bbox[prev].classList.remove('clicked');
                        bbox[prev].innerHTML = '';
                    }
                    flag[i] = 1;
                    bbox[i].classList.add('clicked');
                    bbox[i].innerHTML = score[i].toFixed(2);

                    let url = 'http://127.0.0.1:8080/result'
                    let xhr = new XMLHttpRequest();
                    xhr.open('POST', url, true);
                    let formData = new FormData();
                    formData.append('status', 'clip')
                    formData.append('x0', bbox_c[i][3])
                    formData.append('y0', bbox_c[i][2])
                    formData.append('x1', bbox_c[i][3] + bbox_c[i][0])
                    formData.append('y1', bbox_c[i][2] + bbox_c[i][1])
                    xhr.send(formData)
                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                            let size = JSON.parse(xhr.response)
                            fit_img(size.w, size.h);
                            detail_img.src = './res/clip.png?' + Math.random();
                        }
                    }
                } else if (flag[i] === 1) {
                    flag[i] = 0;
                    bbox[i].classList.remove('clicked');
                    bbox[i].innerHTML = '';
                    detail_img.src = './res/origin.png';
                    fit_img(shape[1], shape[0]);
                }
            }
        }
    } else if (type === 3) {
        for (let k = 0; k < 4; k++) {
            const type_img = document.createElement('img');
            type_img.className = 'types_img';
            full_interact.appendChild(type_img);
            type_img.src = './res/class' + k.toString() + '.png';
        }

        let r = window.innerHeight * 0.95 / shape[0]
        full_interact.style.width = (r * shape[1]).toString() + 'px'
        let d_width = window.innerWidth * 0.95 - r * shape[1] - 70;
        detail.style.width = (d_width).toString() + 'px'
        let d_height = window.innerHeight * 0.95;
        detail_img.style.display = 'none';


        for (let k = 0; k < 4; k++) {
            const oc_types = document.createElement('div');
            oc_types.className = 'oc_types';
            detail.appendChild(oc_types);
            oc_types.style.width = (d_width / 2.2).toString() + 'px';
            oc_types.style.height = (d_height / 2.2).toString() + 'px';

            const oc_types_img = document.createElement('img');
            oc_types_img.className = 'oc_types_img';
            oc_types.appendChild(oc_types_img);
            oc_types_img.src = './res/class' + k.toString() + '.png';

            const oc_types_score = document.createElement('div');
            oc_types_score.className = 'oc_types_score';
            oc_types.appendChild(oc_types_score);
            oc_types_score.innerHTML = score[k].toFixed(4);
            oc_types_score.style.width = (d_width / 2.2).toString() + 'px';
            oc_types_score.style.height = (d_height / 2.2).toString() + 'px';
            oc_types_score.style.lineHeight = (d_height / 2.2).toString() + 'px';
            oc_types_score.style.fontSize = (d_height / 8.8).toString() + 'px';
            oc_types_score.style.left = ((k % 2) * (d_width / 2.2 + d_width * 0.04)).toString() + 'px';
            oc_types_score.style.top = (d_height * 0.02 + (k > 1.5) * (d_height / 2.2 + d_height * 0.02)).toString() + 'px';
        }

        const type_img = document.getElementsByClassName('types_img');
        const oc_types = document.getElementsByClassName('oc_types');
        const oc_types_img = document.getElementsByClassName('oc_types_img');
        const oc_types_score = document.getElementsByClassName('oc_types_score');
        let flag = [0, 0, 0, 0];
        for (let k = 0; k < 4; k++) {
            oc_types[k].onclick = function () {
                if (flag[k] === 0) {
                    let prev = flag.indexOf(1);
                    if (prev > -1) {
                        oc_types_score[prev].classList.remove('show');
                        oc_types_img[prev].classList.remove('focus');
                        type_img[prev].classList.remove('focus');
                        for (let i = 0; i < 4; i++) {
                            if (i !== prev) {
                                type_img[i].classList.remove('blur');
                            }
                        }
                        flag[prev] = 0;
                    }
                    oc_types_score[k].classList.add('show');
                    oc_types_img[k].classList.add('focus');
                    type_img[k].classList.add('focus');
                    for (let i = 0; i < 4; i++) {
                        if (i !== k) {
                            type_img[i].classList.add('blur');
                        }
                    }
                    flag[k] = 1;
                } else if (flag[k] === 1) {
                    oc_types_score[k].classList.remove('show');
                    oc_types_img[k].classList.remove('focus');
                    type_img[k].classList.remove('focus');
                    for (let i = 0; i < 4; i++) {
                        if (i !== k) {
                            type_img[i].classList.remove('blur');
                        }
                    }
                    flag[k] = 0;
                }
            }
        }
    }

    back.onclick = function () {
        mode = 'prev';
        res_prev.classList.remove('full');
        prev_img.classList.remove('fade');
        full_interact.classList.remove('show');
        detail.classList.remove('show');
        ori_img.classList.remove('show');
    }

    back.onmousedown = function () {
        back.classList.add('down');
    }
    back.onmouseup = function () {
        back.classList.remove('down');
        back.classList.remove('show');
    }
</script>
</body>
</html>